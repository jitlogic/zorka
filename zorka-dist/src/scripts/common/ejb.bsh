/**
 * Copyright 2012-2013 Rafal Lewczuk <rafal.lewczuk@jitlogic.com>
 *
 * ZORKA is free software. You can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * ZORKA is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with
 * ZORKA. If not, see <http://www.gnu.org/licenses/>.
 */

__ejb() {

  // Enable or disable all EJB monitoring
  zorka.defCfg("ejb", "yes");

  // Default values for EJB stats
  zorka.defCfg("ejb.stats", "yes");
  zorka.defCfg("ejb.stats.congestion", "yes");
  zorka.defCfg("ejb.stats.mbean", "zorka:type=ZorkaStats,name=EjbStats");


  // Default values for HTTP parameter processing
  zorka.defCfg("ejb.params", "no");
  zorka.defCfg("ejb.params.include", "");
  zorka.defCfg("ejb.params.exclude", "**");


  // Default values for EJB slow calls log configuration options
  zorka.defCfg("ejb.slow.log", "no");
  zorka.defCfg("ejb.slow.time", "1000");
  zorka.defCfg("ejb.slow.file", "yes");
  zorka.defCfg("ejb.slow.file.path", zorka.path("${zorka.log.dir}", "ejb-slow.log"));
  zorka.defCfg("ejb.slow.file.max", "8M");
  zorka.defCfg("ejb.slow.file.num", "8");
  zorka.defCfg("ejb.slow.format", "[${TIME}] ${CLASS}.${METHOD}(${PARAMS}) -> ${RET}");


  // Default values for EJB error log configuration options
  zorka.defCfg("ejb.error.log", "no");
  zorka.defCfg("ejb.error.file", "yes");
  zorka.defCfg("ejb.error.file.path", zorka.path("${zorka.log.dir}", "http-error.log"));
  zorka.defCfg("ejb.error.file.max", "8M");
  zorka.defCfg("ejb.error.file.num", "8");
  zorka.defCfg("ejb.error.format", "[${TIME}] ${CLASS}.${METHOD}(${PARAMS}) -> ${ERR}");

  // Default values for HTTP tracer options
  zorka.defCfg("ejb.trace", zorka.stringCfg("tracer"));
  zorka.defCfg("ejb.trace.time", "1000");
  zorka.defCfg("ejb.trace.params.prefix", "P:");

  _mbean = zorka.stringCfg("ejb.stats.mbean");

  discovery(attr, tag) {
    return zabbix.discovery(zorka.query("java", _mbean, "name", "type").get(attr).listAs("**", tag));
  }

  calls(attr, tag) {
    calls = zorka.jmx("java", _mbean, attr, tag, "calls");
    return calls != null ? calls : 0;
  }

  errors(attr, tag) {
    errors = zorka.jmx("java", _mbean, attr, tag, "errors");
    return errors != null ? errors : 0;
  }

  peak(attr, tag) {
    peak = zorka.jmx("java",  _mbean, attr, tag, "maxTimeCLR");
    return peak != null ? peak : 0;
  }

  threads(attr, tag) {
    tag = clazz + "." + method;
    threads = zorka.jmx("java",  _mbean, attr, tag, "maxThreadsCLR");
  }

  avg5(attr, tag) {
    tag = clazz + "." + method;
    return zorka.rate("java", _mbean, attr, tag, "time", "calls", "AVG5");
  }

  avg15(attr, tag) {
    tag = clazz + "." + method;
    return zorka.rate("java", _mbean, attr, tag, "time", "calls", "AVG15");
  }


  return this;
}

ejb = __ejb();

